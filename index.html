<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bản đồ số vụ khủng bố theo năm</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      #chart { width: 100%; height: 100vh; }
      .note { position: fixed; right: 16px; bottom: 12px; font-size: 12px; color: #666; background: rgba(255,255,255,0.8); padding: 6px 8px; border-radius: 6px; }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  </head>
  <body>
    <div id="chart"></div>
    <div class="note">Nguồn: OWID (file `terrorist-attacks-clean.json`)</div>
    <script>
      // Helper: mapping country names to ISO-3 used by Plotly
      // Minimal curated list; for names not found we'll try a lookup map below.
      const nameToIso3 = {
        "United States": "USA",
        "United Kingdom": "GBR",
        "Czechia": "CZE",
        "Democratic Republic of Congo": "COD",
        "Republic of the Congo": "COG",
        "South Korea": "KOR",
        "North Korea": "PRK",
        "Russia": "RUS",
        "Vietnam": "VNM",
        "Laos": "LAO",
        "Ivory Coast": "CIV",
        "Côte d’Ivoire": "CIV",
        "Cote d'Ivoire": "CIV",
        "Eswatini": "SWZ",
        "Swaziland": "SWZ",
        "Syria": "SYR",
        "Iran": "IRN",
        "Venezuela": "VEN",
        "Bolivia": "BOL",
        "Tanzania": "TZA",
        "Myanmar": "MMR",
        "Moldova": "MDA",
        "Cape Verde": "CPV",
        "Timor": "TLS"
      };

      // Fallback rough ISO3 generator (very limited accuracy)
      function guessIso3(name) {
        if (nameToIso3[name]) return nameToIso3[name];
        // Try using Intl.DisplayNames if available to normalize common variants
        const replacements = {
          "Democratic Republic of the Congo": "COD",
          "Congo": "COG",
          "Palestine": "PSE",
          "Kosovo": "XKX",
          "Micronesia": "FSM",
          "North Macedonia": "MKD",
          "Türkiye": "TUR",
          "Burma": "MMR",
          "Soviet Union": "RUS",
        };
        if (replacements[name]) return replacements[name];
        return undefined;
      }

      async function loadData() {
        const resp = await fetch('terrorist-attacks-clean.json');
        const raw = await resp.json();
        // Data shape: { Entity, Year, "Terrorist attacks" }
        // Build: year -> { iso3 -> value }
        const byYear = new Map();
        let minYear = Infinity, maxYear = -Infinity;
        for (const row of raw) {
          const country = row["Entity"];
          const year = row["Year"];
          const value = row["Terrorist attacks"]; // number
          if (country == null || year == null) continue;
          const iso3 = guessIso3(country);
          if (!iso3) continue; // skip unknown names
          if (!byYear.has(year)) byYear.set(year, new Map());
          byYear.get(year).set(iso3, value ?? 0);
          if (year < minYear) minYear = year;
          if (year > maxYear) maxYear = year;
        }
        return { byYear, minYear, maxYear };
      }

      // Discrete bins like the screenshot
      const binEdges = [0, 1, 3, 10, 30, 100, 300, 1000, 3000, 10000];
      const binColors = [
        '#fae9d1', '#f6d6ad', '#f3c38e', '#f0ad72', '#ec8f5e',
        '#e0634e', '#c53b2c', '#a4161a', '#7a0c10', '#5a070b'
      ];

      function valueToColor(v) {
        if (v === null || v === undefined) return '#e0e0e0';
        for (let i = binEdges.length - 1; i >= 0; i--) {
          if (v >= binEdges[i]) return binColors[i];
        }
        return binColors[0];
      }

      function legendTrace() {
        // Fake scatter for discrete legend labels
        const labels = ['0','1','3','10','30','100','300','1,000','3,000','10,000+'];
        return {
          x: new Array(labels.length).fill(0),
          y: new Array(labels.length).fill(0),
          mode: 'markers',
          marker: { size: 0 },
          showlegend: true,
          name: 'Chú giải (mốc)',
          hoverinfo: 'skip',
          legendgroup: 'bins'
        };
      }

      function yearFrame(year, seriesMap) {
        const locations = [];
        const z = [];
        const colors = [];
        for (const [iso3, val] of seriesMap.entries()) {
          locations.push(iso3);
          z.push(val ?? 0);
          colors.push(valueToColor(val ?? 0));
        }
        return {
          name: String(year),
          data: [{
            type: 'choropleth',
            locationmode: 'ISO-3',
            locations,
            z,
            zauto: false,
            showscale: false,
            hovertemplate: '%{location}: %{z}<extra></extra>',
            marker: { line: { color: 'rgba(255,255,255,0.7)', width: 0.3 } },
            colorscale: binColors.map((c, i) => [i/(binColors.length-1), c]),
            autocolorscale: false,
            // Use custom discrete colors by overriding via marker.colors
            marker: { line: { color: 'rgba(255,255,255,0.7)', width: 0.3 } },
            // Plotly choropleth doesn't accept per-cell color directly; we mimic via z + colorscale.
          }]
        };
      }

      (async function init() {
        const { byYear, minYear, maxYear } = await loadData();
        const years = [];
        for (let y = minYear; y <= maxYear; y++) if (byYear.has(y)) years.push(y);

        // Build frames
        const frames = years.map(y => yearFrame(y, byYear.get(y)));
        const firstFrame = frames[0];

        const layout = {
          title: { text: 'Số vụ khủng bố theo quốc gia', x: 0.02, y: 0.98 },
          geo: {
            projection: { type: 'natural earth' },
            showframe: false,
            showcountries: true,
            countrycolor: 'rgba(0,0,0,0.15)'
          },
          margin: { l: 0, r: 0, t: 40, b: 40 },
          updatemenus: [{
            type: 'buttons',
            direction: 'left',
            x: 0.02,
            y: 0.03,
            showactive: false,
            buttons: [
              {
                label: '▶',
                method: 'animate',
                args: [null, { fromcurrent: true, frame: { duration: 400, redraw: false }, transition: { duration: 0 }, mode: 'immediate' }]
              },
              {
                label: '❚❚',
                method: 'animate',
                args: [[null], { mode: 'immediate', frame: { duration: 0, redraw: false }, transition: { duration: 0 } }]
              }
            ]
          }],
          sliders: [{
            x: 0.1, len: 0.8, y: 0.02,
            pad: { t: 25, b: 0 },
            currentvalue: { visible: true, prefix: '', xanchor: 'right', offset: 10 },
            steps: years.map(y => ({
              label: String(y),
              method: 'animate',
              args: [[String(y)], { mode: 'immediate', transition: { duration: 0 }, frame: { duration: 0, redraw: false } }]
            }))
          }]
        };

        const data = firstFrame ? firstFrame.data : [];

        Plotly.newPlot('chart', data, layout, { responsive: true, displaylogo: false });
        if (frames.length > 0) {
          Plotly.addFrames('chart', frames);
        }
      })();
    </script>
  </body>
  </html>


