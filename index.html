<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Terrorist Attacks Worldwide (1970–2021)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; font-family: "Inter", Arial, sans-serif; background: #fff; color: #222; }
    h1 { font-size: 22px; text-align: center; margin: 14px 0 4px; }
    .sub { text-align: center; color: #666; font-size: 13px; margin-bottom: 10px; }
    #map { height: 600px; width: 100%; border-radius: 12px; }
    .panel {
      display: flex; justify-content: center; align-items: center;
      gap: 16px; margin: 16px auto; padding: 8px;
      font-size: 13px; color: #444;
    }
    input[type=range] { width: 400px; }
    button {
      border: 1px solid #ccc; background: #fff; cursor: pointer;
      padding: 6px 10px; border-radius: 8px; font-size: 14px;
    }
    .legend {
      margin-top: 10px;
      display: flex; flex-direction: column; align-items: center;
      font-size: 11px; color: #333;
    }
    .legend-bar {
      height: 14px; width: 420px;
      background: linear-gradient(90deg,#fff5eb,#fee6ce,#fdd0a2,#fdae6b,#fd8d3c,#f16938,#e6550d,#d7301f,#a50f15,#6b0d13);
      border: 1px solid #ccc; border-radius: 4px;
    }
    .legend-ticks {
      display: flex; justify-content: space-between; width: 420px;
      margin-top: 4px; font-size: 11px; color: #444;
    }
    .tooltip {
      position: absolute; background: #111; color: #fff;
      padding: 6px 8px; border-radius: 6px; font-size: 12px;
      pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
  </style>
</head>
<body>
  <h1>Number of terrorist attacks</h1>
  <div class="sub">1970–2021 • Global Terrorism Database (Our World in Data)</div>
  <div id="map"></div>

  <div class="panel">
    <button id="play">▶</button>
    <span>1970</span>
    <input id="year" type="range" min="1970" max="2021" value="1970">
    <span>2021</span>
  </div>

  <div class="legend">
    <div class="legend-bar"></div>
    <div class="legend-ticks">
      <span>0</span><span>1</span><span>3</span><span>10</span><span>30</span><span>100</span>
      <span>300</span><span>1k</span><span>3k</span><span>10k</span>
    </div>
  </div>

  <script>
    const BREAKS = [0,1,3,10,30,100,300,1000,3000,10000];
    const COLORS = ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16938','#e6550d','#d7301f','#a50f15','#6b0d13'];
    const YEARS = {min:1970,max:2021};

    const map = L.map('map').setView([20,10], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:5,minZoom:2,opacity:0.25,attribution:'© OpenStreetMap contributors'}).addTo(map);

    let geoLayer, tooltip = d3.select("body").append("div").attr("class","tooltip");
    let DATA = null;

    function getColor(v) {
      if (v==null || isNaN(v)) return '#ccc';
      for (let i=BREAKS.length-1;i>=0;i--) if(v>=BREAKS[i]) return COLORS[i];
      return COLORS[0];
    }
    function formatNumber(n){
      if (n==null||isNaN(n)) return 'No data';
      return n>=1e6? d3.format('.2s')(n): d3.format(',')(n);
    }

    function updateMap(year){
      if (!geoLayer || !DATA) return;
      geoLayer.eachLayer(layer=>{
        const iso = layer.feature.properties.iso_a3;
        const val = (DATA[year] && DATA[year][iso]) || null;
        layer.setStyle({fillColor:getColor(val),fillOpacity:0.9,color:'#fff',weight:0.6});
      });
    }

    Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.json("terrorist-attacks-clean.json")
    ]).then(([world, data])=>{
      DATA = data;
      geoLayer = L.geoJSON(world,{
        style: f=>({fillColor:'#ccc',color:'#fff',weight:0.6,fillOpacity:0.9}),
        onEachFeature:(f,layer)=>{
          layer.on('mousemove',e=>{
            const year=document.getElementById('year').value;
            const iso=f.properties.iso_a3;
            const val=(DATA[year]&&DATA[year][iso])||null;
            tooltip.style("opacity",1)
              .html(`<b>${f.properties.name}</b><br>${year}: ${formatNumber(val)} attacks`)
              .style("left",(e.originalEvent.pageX+10)+"px")
              .style("top",(e.originalEvent.pageY-20)+"px");
          });
          layer.on('mouseout',()=>tooltip.style("opacity",0));
        }
      }).addTo(map);
      updateMap(1970);
    });

    document.getElementById('year').addEventListener('input',e=>updateMap(e.target.value));

    let playing=false,timer=null;
    document.getElementById('play').addEventListener('click',()=>{
      playing=!playing;
      document.getElementById('play').innerText = playing ? '❚❚' : '▶';
      if(playing){
        let year=+document.getElementById('year').value;
        timer=setInterval(()=>{
          year++; if(year>YEARS.max) year=YEARS.min;
          document.getElementById('year').value=year;
          updateMap(year);
        },700);
      }else clearInterval(timer);
    });
  </script>
</body>
</html>
